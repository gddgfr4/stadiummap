<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>陸上競技場マップ</title>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
        }
        #app-container { display: flex; flex-direction: column; height: 100%; }
        header {
            background-color: #2c3e50; color: white; padding: 1rem;
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        h1 { margin: 0; font-size: 1.5rem; }
        #user-info { font-size: 0.8rem; margin-top: 4px; opacity: 0.8; }
        #map { flex-grow: 1; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 15px; font-size: 14px; line-height: 1.6; width: 280px !important; }
        
        .stadium-link {
            display: inline-block; margin-bottom: 12px; padding: 8px 14px;
            background-color: #3498db; color: white; text-decoration: none;
            border-radius: 5px; transition: background-color 0.3s;
        }
        .stadium-link:hover { background-color: #2980b9; }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 8px;
        }
        .calendar-day {
            padding: 5px; border: 1px solid #ccc;
            background-color: #f9f9f9; border-radius: 5px; cursor: pointer;
            transition: all 0.2s; text-align: center;
        }
        .calendar-day:hover { background-color: #e9e9e9; border-color: #999; }
        .calendar-day.active {
            background-color: #2ecc71; color: white; border-color: #27ae60; font-weight: bold;
        }
        .calendar-day.today { border-color: #3498db; border-width: 2px; }
        .day-header { font-size: 11px; color: #777; }
        .day-date { font-size: 16px; font-weight: bold; }
        .calendar-day.active .day-header { color: #fff; opacity: 0.9; }
        .attendees-list {
            font-size: 10px; line-height: 1.2; margin-top: 4px;
            color: #555; word-break: break-all;
        }
        .calendar-day.active .attendees-list { color: white; }


        .emoji-icon {
            font-size: 28px; text-shadow: 0 0 3px rgba(0,0,0,0.3); position: relative;
        }
        .attendance-badge {
            position: absolute; top: -5px; right: -8px;
            background-color: #e74c3c; color: white;
            border-radius: 50%; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1>陸上競技場マップ</h1>
            <div id="user-info"></div>
        </header>
        <div id="map"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8oCOusnqZCSax9ZY3-n4KNt2AxEmvT-E",
            authDomain: "athlog-126d2.firebaseapp.com",
            projectId: "athlog-126d2",
            storageBucket: "athlog-126d2.appspot.com",
            messagingSenderId: "784178114661",
            appId: "1:784178114661:web:d41103b0dad1187b85168c"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- Global State ---
        let teamId, memberId, isLoggedIn = false;
        const markers = {};
        let plansUnsubscribe = null;
        const weekDays = ['日', '月', '火', '水', '木', '金', '土'];

        // --- Stadium Data ---
        const stadiums = [
            { id: 'komazawa', name: '駒沢オリンピック公園陸上競技場', lat: 35.6236, lng: 139.6630, url: 'https://www.tef.or.jp/kopg/training_top.jsp' },
            { id: 'yoyogi', name: '代々木公園陸上競技場', lat: 35.6685, lng: 139.6950, url: 'https://www.tokyo-park.or.jp/park/format/index039.html' },
            { id: 'edogawa', name: '江戸川区陸上競技場', lat: 35.7088, lng: 139.8706, url: 'https://www.edogawa-3field.jp/stadium/personal/' },
            { id: 'okura', name: '大蔵運動公園陸上競技場', lat: 35.6360, lng: 139.6102, url: 'https://www.se-sports.or.jp/facility/okura/okura.php' },
            { id: 'yumenoshima', name: '夢の島公園陸上競技場', lat: 35.6558, lng: 139.8275, url: 'https://www.yumenoshima.jp/personal.html' },
            { id: 'national', name: '国立競技場', lat: 35.6778, lng: 139.7145, url: 'https://www.jpnsport.go.jp/' },
            { id: 'chofu', name: '調布市営陸上競技場', lat: 35.6635, lng: 139.5248, url: 'https://www.ajinomotostadium.com/overview/second.php' },
            { id: 'kamiyugi', name: '上柚木公園陸上競技場', lat: 35.6175, lng: 139.3800, url: 'https://www.hachioji-sports.jp/kamiyugi/' },
            { id: 'akirudai', name: '秋留台公園陸上競技場', lat: 35.7288, lng: 139.2785, url: 'https://www.tokyo-park.or.jp/park/format/index053.html' },
            { id: 'machida', name: '町田GIONスタジアム', lat: 35.5125, lng: 139.4261, url: 'https://www.zelvia.co.jp/stadium/gion-stadium/' },
            { id: 'sagamihara', name: '相模原ギオンスタジアム', lat: 35.5311, lng: 139.3516, url: 'https://www.sagamihara-stadium.jp/' },
            { id: 'nissan', name: '日産スタジアム', lat: 35.5101, lng: 139.6063, url: 'https://www.nissan-stadium.jp/track/index.php' },
            { id: 'todoroki', name: '等々力陸上競技場', lat: 35.5866, lng: 139.6508, url: 'https://www.city.kawasaki.jp/shisetsu/category/30-4-0-0-0-0-0-0-0-0.html' },
            { id: 'hiratsuka', name: 'レモンガススタジアム平塚', lat: 35.3400, lng: 139.3400, url: 'https://www.bellmare-park.com/' },
        ];
        
        // --- Date Helpers ---
        const getYMD = (date) => date.toISOString().slice(0, 10);
        const getNext7Days = () => Array.from({length: 7}, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() + i);
            return date;
        });

        // --- Map Initialization ---
        const map = L.map('map').setView([35.65, 139.6], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- Firestore Interaction ---
        async function togglePlan(stadiumId, dateString) {
            if (!isLoggedIn) return;
            const planRef = db.collection('teams').doc(teamId).collection('stadium_plans').doc(stadiumId);
            
            // Use a transaction to safely read-then-write
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(planRef);
                const plans = doc.data()?.plans || {};
                const attendees = plans[dateString] || [];

                if (attendees.includes(memberId)) {
                    // Already attending, so remove
                    plans[dateString] = attendees.filter(id => id !== memberId);
                } else {
                    // Not attending, so add
                    attendees.push(memberId);
                    plans[dateString] = attendees;
                }
                
                // Clean up empty date entries
                if (plans[dateString].length === 0) {
                    delete plans[dateString];
                }

                transaction.set(planRef, { plans }, { merge: true });
            });
        }

        // --- UI Update Function ---
        function updateMarkersUI(allPlansData) {
            const sevenDays = getNext7Days();
            const sevenDayStrings = sevenDays.map(getYMD);

            stadiums.forEach(stadium => {
                const marker = markers[stadium.id];
                if (!marker) return;

                const stadiumPlans = allPlansData[stadium.id]?.plans || {};
                
                // 1. Update Badge
                let totalAttendees = new Set();
                sevenDayStrings.forEach(dateStr => {
                    (stadiumPlans[dateStr] || []).forEach(attendee => totalAttendees.add(attendee));
                });
                const iconHtml = `🏟️${totalAttendees.size > 0 ? `<div class="attendance-badge">${totalAttendees.size}</div>` : ''}`;
                marker.getIcon().options.html = iconHtml;
                marker.setIcon(marker.getIcon());

                // 2. Update Popup Content
                let calendarHtml = '<div class="calendar-grid">';
                sevenDays.forEach((date, i) => {
                    const dateStr = sevenDayStrings[i];
                    const attendees = stadiumPlans[dateStr] || [];
                    const isCurrentUserAttending = attendees.includes(memberId);
                    const isToday = i === 0;

                    const activeClass = isCurrentUserAttending ? 'active' : '';
                    const todayClass = isToday ? 'today' : '';

                    calendarHtml += `
                        <div class="calendar-day ${activeClass} ${todayClass}" onclick="togglePlan('${stadium.id}', '${dateStr}')">
                            <div class="day-header">${weekDays[date.getDay()]}</div>
                            <div class="day-date">${date.getDate()}</div>
                            <div class="attendees-list">${attendees.join('<br>')}</div>
                        </div>
                    `;
                });
                calendarHtml += '</div>';

                const popupContent = `
                    <b>${stadium.name}</b><br>
                    <a href="${stadium.url}" target="_blank" rel="noopener noreferrer" class="stadium-link">
                        公式サイトで確認
                    </a>
                    ${calendarHtml}
                `;
                marker.setPopupContent(popupContent);
            });
        }
        
        // --- Realtime Data Listener ---
        function listenToPlans() {
            if (plansUnsubscribe) plansUnsubscribe();
            if (!isLoggedIn) return;

            plansUnsubscribe = db.collection('teams').doc(teamId).collection('stadium_plans')
                .onSnapshot(snapshot => {
                    const allPlans = {};
                    snapshot.forEach(doc => {
                        allPlans[doc.id] = doc.data();
                    });
                    updateMarkersUI(allPlans);
                }, error => console.error("Failed to listen to plans:", error));
        }

        // --- App Initialization ---
        function initialize() {
            const params = new URLSearchParams(window.location.search);
            teamId = params.get('team');
            memberId = params.get('member');
            const userInfoDiv = document.getElementById('user-info');

            if (teamId && memberId) {
                isLoggedIn = true;
                userInfoDiv.textContent = `Team: ${teamId} / Member: ${memberId}`;
            } else {
                isLoggedIn = false;
                userInfoDiv.textContent = 'ログイン情報がありません。AthLogからアクセスしてください。';
            }

            stadiums.forEach(stadium => {
                const stadiumIcon = L.divIcon({
                    html: '🏟️', className: 'emoji-icon',
                    iconSize: [40, 40], iconAnchor: [20, 40]
                });
                const marker = L.marker([stadium.lat, stadium.lng], { icon: stadiumIcon }).addTo(map);
                
                marker.bindPopup(`<b>${stadium.name}</b><br>予定を読み込み中...`);
                markers[stadium.id] = marker;
            });
            
            listenToPlans();
            if (!isLoggedIn) {
                updateMarkersUI({});
            }
        }

        initialize();
    </script>
</body>
</html>

