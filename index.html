<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–¢æ± é™¸ä¸Šç«¶æŠ€å ´ãƒãƒƒãƒ—</title>
    <!-- Leaflet.jsã®CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet.jsã®JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        html, body {
            height: 100%; margin: 0; padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
        }
        #app-container { display: flex; flex-direction: column; height: 100%; }
        header {
            background-color: #2c3e50; color: white; padding: 1rem;
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        h1 { margin: 0; font-size: 1.5rem; }
        #user-info { font-size: 0.8rem; margin-top: 4px; opacity: 0.8; }
        #map { flex-grow: 1; }
        .leaflet-popup-content-wrapper { border-radius: 8px; }
        .leaflet-popup-content { margin: 15px 20px; font-size: 14px; line-height: 1.6; }
        .stadium-link {
            display: inline-block; margin-top: 10px; padding: 8px 14px;
            background-color: #3498db; color: white; text-decoration: none;
            border-radius: 5px; transition: background-color 0.3s;
        }
        .stadium-link:hover { background-color: #2980b9; }
        .plan-buttons { margin-top: 12px; display: flex; gap: 8px; }
        .plan-button {
            flex: 1; padding: 8px; border: 1px solid #ccc;
            background-color: #f4f4f4; border-radius: 5px; cursor: pointer;
            transition: all 0.2s;
        }
        .plan-button:hover { background-color: #e9e9e9; border-color: #999; }
        .plan-button.cancel { background-color: #e74c3c; color: white; border-color: #c0392b; }
        .plan-button.active {
            background-color: #2ecc71; color: white; border-color: #27ae60; font-weight: bold;
        }
        .plan-button:disabled { background-color: #bdc3c7; cursor: not-allowed; color: #7f8c8d; }
        .attendees { margin-top: 10px; font-size: 12px; color: #555; }
        .attendees b { color: #000; }
        .emoji-icon {
            font-size: 28px;
            text-shadow: 0 0 3px rgba(0,0,0,0.3);
            position: relative;
        }
        .attendance-badge {
            position: absolute; top: -5px; right: -8px;
            background-color: #e74c3c; color: white;
            border-radius: 50%; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1>é–¢æ± é™¸ä¸Šç«¶æŠ€å ´ãƒãƒƒãƒ—</h1>
            <div id="user-info"></div>
        </header>
        <div id="map"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- AthLogã¨åŒã˜Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyA8oCOusnqZCSax9ZY3-n4KNt2AxEmvT-E",
            authDomain: "athlog-126d2.firebaseapp.com",
            projectId: "athlog-126d2",
            storageBucket: "athlog-126d2.appspot.com",
            messagingSenderId: "784178114661",
            appId: "1:784178114661:web:d41103b0dad1187b85168c"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let teamId = null;
        let memberId = null;
        let isLoggedIn = false;
        const markers = {};
        let plansUnsubscribe = null;

        // --- ç«¶æŠ€å ´ãƒ‡ãƒ¼ã‚¿ ---
        const stadiums = [
            // æ±äº¬
            { id: 'komazawa', name: 'é§’æ²¢ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯å…¬åœ’ç·åˆé‹å‹•å ´é™¸ä¸Šç«¶æŠ€å ´', lat: 35.6236, lng: 139.6630, url: 'https://www.tef.or.jp/kopg/training_top.jsp' },
            { id: 'yoyogi', name: 'ä»£ã€…æœ¨å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´', lat: 35.6685, lng: 139.6950, url: 'https://www.tokyo-park.or.jp/park/format/index039.html' },
            { id: 'edogawa', name: 'æ±Ÿæˆ¸å·åŒºé™¸ä¸Šç«¶æŠ€å ´', lat: 35.7088, lng: 139.8706, url: 'https://www.edogawa-3field.jp/stadium/personal/' },
            { id: 'okura', name: 'ä¸–ç”°è°·åŒºç«‹å¤§è”µé‹å‹•å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´', lat: 35.6360, lng: 139.6102, url: 'https://www.se-sports.or.jp/facility/okura/okura.php' },
            { id: 'yumenoshima', name: 'å¤¢ã®å³¶å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´', lat: 35.6558, lng: 139.8275, url: 'https://www.yumenoshima.jp/personal.html' },
            { id: 'national', name: 'å›½ç«‹ç«¶æŠ€å ´', lat: 35.6778, lng: 139.7145, url: 'https://www.jpnsport.go.jp/' },
            // ç¥å¥ˆå·
            { id: 'nissan', name: 'æ—¥ç”£ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ', lat: 35.5101, lng: 139.6063, url: 'https://www.nissan-stadium.jp/track/index.php' },
            { id: 'todoroki', name: 'ç­‰ã€…åŠ›é™¸ä¸Šç«¶æŠ€å ´', lat: 35.5866, lng: 139.6508, url: 'https://www.city.kawasaki.jp/shisetsu/category/30-4-0-0-0-0-0-0-0-0.html' },
            { id: 'hiratsuka', name: 'ãƒ¬ãƒ¢ãƒ³ã‚¬ã‚¹ã‚¹ã‚¿ã‚¸ã‚¢ãƒ å¹³å¡š', lat: 35.3400, lng: 139.3400, url: 'https://www.bellmare-park.com/' },
            // åŸ¼ç‰
            { id: 'saitama', name: 'åŸ¼ç‰ã‚¹ã‚¿ã‚¸ã‚¢ãƒ 2002', lat: 35.9038, lng: 139.7166, url: 'https://www.stadium2002.com/' },
            { id: 'kumagaya', name: 'ç†Šè°·ã‚¹ãƒãƒ¼ãƒ„æ–‡åŒ–å…¬åœ’é™¸ä¸Šç«¶æŠ€å ´', lat: 36.1600, lng: 139.4215, url: 'https://www.parks.or.jp/kumagaya/' },
            // åƒè‘‰
            { id: 'chiba', name: 'åƒè‘‰çœŒç·åˆã‚¹ãƒãƒ¼ãƒ„ã‚»ãƒ³ã‚¿ãƒ¼é™¸ä¸Šç«¶æŠ€å ´', lat: 35.6262, lng: 140.1473, url: 'http://www.cue-net.or.jp/kouen/sportscenter/index.html' },
            { id: 'fukuda', name: 'ãƒ•ã‚¯ãƒ€é›»å­ã‚¢ãƒªãƒ¼ãƒŠ', lat: 35.5900, lng: 140.1218, url: 'https://www.soga-sportspark.com/facility/fukuda.html' },
        ];
        
        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—ã«å¤‰æ›
        function getYMD(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // --- åœ°å›³ã®åˆæœŸè¨­å®š ---
        const map = L.map('map').setView([35.7, 139.75], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- Firestoreé–¢é€£ã®é–¢æ•° ---
        async function setPlan(stadiumId, plan) {
            if (!isLoggedIn) return;
            const planRef = db.collection('teams').doc(teamId).collection('stadium_plans').doc(stadiumId);
            const data = {
                plan: plan, // 'today' or 'tomorrow'
                ts: firebase.firestore.FieldValue.serverTimestamp() // ã‚µãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨
            };

            try {
                if (plan === 'cancel') {
                    await planRef.update({ [`attendees.${memberId}`]: firebase.firestore.FieldValue.delete() });
                } else {
                    await planRef.set({ attendees: { [memberId]: data } }, { merge: true });
                }
            } catch (error) {
                console.error("Plan update failed:", error);
            }
        }

        // --- UIæ›´æ–°ã®ãƒ¡ã‚¤ãƒ³é–¢æ•° ---
        function updateMarkersUI(plans) {
            const todayStr = getYMD(new Date());
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getYMD(yesterday);

            stadiums.forEach(stadium => {
                const marker = markers[stadium.id];
                if (!marker) return;

                const stadiumPlan = plans[stadium.id];
                const attendees = stadiumPlan?.attendees || {};
                
                const goingToday = [];
                const goingTomorrow = [];
                let currentUserPlan = null;

                for (const member in attendees) {
                    const { plan, ts } = attendees[member];
                    // Firestoreã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯ .toDate() ã§JSã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
                    const planDate = ts ? ts.toDate() : new Date(0);
                    const planDateStr = getYMD(planDate);
                    let isPlanValid = false;

                    if (plan === 'today' && planDateStr === todayStr) {
                        goingToday.push(member);
                        isPlanValid = true;
                    } else if (plan === 'tomorrow' && (planDateStr === todayStr || planDateStr === yesterdayStr)) {
                        goingTomorrow.push(member);
                        isPlanValid = true;
                    }
                    
                    if (member === memberId && isPlanValid) {
                        currentUserPlan = plan;
                    }
                }

                // ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒã‚¸ã‚’æ›´æ–°
                const totalAttendees = goingToday.length + goingTomorrow.length;
                const iconHtml = `ğŸŸï¸${totalAttendees > 0 ? `<div class="attendance-badge">${totalAttendees}</div>` : ''}`;
                marker.getIcon().options.html = iconHtml;
                marker.setIcon(marker.getIcon());

                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­èº«ã‚’æ›´æ–°
                let attendeesHtml = '<div class="attendees">';
                if (goingToday.length > 0) attendeesHtml += `<b>ä»Šæ—¥:</b> ${goingToday.join(', ')}<br>`;
                if (goingTomorrow.length > 0) attendeesHtml += `<b>æ˜æ—¥:</b> ${goingTomorrow.join(', ')}`;
                if (totalAttendees === 0) attendeesHtml += 'ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“';
                attendeesHtml += '</div>';

                const disabledAttr = isLoggedIn ? '' : 'disabled';
                const popupContent = `
                    <b>${stadium.name}</b><br>
                    ${attendeesHtml}
                    <a href="${stadium.url}" target="_blank" rel="noopener noreferrer" class="stadium-link">
                        å…¬å¼ã‚µã‚¤ãƒˆã§ç¢ºèª
                    </a>
                    <div class="plan-buttons">
                        <button class="plan-button ${currentUserPlan === 'today' ? 'active' : ''}" onclick="setPlan('${stadium.id}', 'today')" ${disabledAttr}>ä»Šæ—¥è¡Œã</button>
                        <button class="plan-button ${currentUserPlan === 'tomorrow' ? 'active' : ''}" onclick="setPlan('${stadium.id}', 'tomorrow')" ${disabledAttr}>æ˜æ—¥è¡Œã</button>
                        <button class="plan-button cancel" onclick="setPlan('${stadium.id}', 'cancel')" ${disabledAttr}>å–æ¶ˆ</button>
                    </div>
                `;
                marker.setPopupContent(popupContent);
            });
        }
        
        function listenToPlans() {
            if (plansUnsubscribe) plansUnsubscribe();
            if (!isLoggedIn) return;

            plansUnsubscribe = db.collection('teams').doc(teamId).collection('stadium_plans')
                .onSnapshot(snapshot => {
                    const allPlans = {};
                    snapshot.forEach(doc => {
                        allPlans[doc.id] = doc.data();
                    });
                    updateMarkersUI(allPlans);
                }, error => console.error("Failed to listen to plans:", error));
        }

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ– ---
        function initialize() {
            const params = new URLSearchParams(window.location.search);
            teamId = params.get('team');
            memberId = params.get('member');
            const userInfoDiv = document.getElementById('user-info');

            if (teamId && memberId) {
                isLoggedIn = true;
                userInfoDiv.textContent = `Team: ${teamId} / Member: ${memberId}`;
            } else {
                isLoggedIn = false;
                userInfoDiv.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚AthLogã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚';
            }

            // ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
            stadiums.forEach(stadium => {
                const stadiumIcon = L.divIcon({
                    html: 'ğŸŸï¸', className: 'emoji-icon',
                    iconSize: [40, 40], iconAnchor: [20, 40]
                });
                const marker = L.marker([stadium.lat, stadium.lng], { icon: stadiumIcon }).addTo(map);
                
                const disabledAttr = isLoggedIn ? '' : 'disabled';
                const initialPopupContent = `
                    <b>${stadium.name}</b><br>
                    <div class="attendees">äºˆå®šã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                     <a href="${stadium.url}" target="_blank" rel="noopener noreferrer" class="stadium-link">
                        å…¬å¼ã‚µã‚¤ãƒˆã§ç¢ºèª
                    </a>
                    <div class="plan-buttons">
                        <button class="plan-button" onclick="setPlan('${stadium.id}', 'today')" ${disabledAttr}>ä»Šæ—¥è¡Œã</button>
                        <button class="plan-button" onclick="setPlan('${stadium.id}', 'tomorrow')" ${disabledAttr}>æ˜æ—¥è¡Œã</button>
                        <button class="plan-button cancel" onclick="setPlan('${stadium.id}', 'cancel')" ${disabledAttr}>å–æ¶ˆ</button>
                    </div>
                `;
                marker.bindPopup(initialPopupContent);
                markers[stadium.id] = marker;
            });
            
            listenToPlans();
            if (!isLoggedIn) {
                updateMarkersUI({}); // ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿ã§UIã‚’åˆæœŸåŒ–
            }
        }

        initialize();
    </script>
</body>
</html>

